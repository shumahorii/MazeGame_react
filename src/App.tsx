import React, { useEffect, useState } from 'react'; // Reactã®åŸºæœ¬çš„ãªæ©Ÿèƒ½ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
import './App.css'; // CSSã‚¹ã‚¿ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿

// -----------------------------
// å®šæ•°ã‚„å‹å®šç¾©
// -----------------------------

// è¿·è·¯ã®æ¨ªå¹…ã¨é«˜ã•ï¼ˆå¥‡æ•°ã«ã™ã‚‹ã¨é€šè·¯ã¨å£ã‚’äº¤äº’ã«ã§ãã‚‹ï¼‰
const MAZE_WIDTH = 21;
const MAZE_HEIGHT = 21;

// ã‚»ãƒ«ã®å‹ï¼š0ã¯ã€Œå£ã€ã€1ã¯ã€Œé€šè·¯ã€ã¨ã—ã¦æ‰±ã†
type Cell = 0 | 1;

// è¿·è·¯ã¯ã€Cellï¼ˆäºŒæ¬¡å…ƒé…åˆ—ï¼‰ã®é…åˆ—ã¨ã—ã¦è¡¨ç¾
type Maze = Cell[][];

// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åˆæœŸä½ç½®ï¼ˆå·¦ä¸Šã®é€šè·¯ï¼‰
const START_X = 1;
const START_Y = 1;

// ã‚´ãƒ¼ãƒ«ã®ä½ç½®ï¼ˆå³ä¸‹ã®é€šè·¯ï¼‰
const GOAL_X = MAZE_WIDTH - 2;
const GOAL_Y = MAZE_HEIGHT - 2;

// -----------------------------
// è¿·è·¯ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹é–¢æ•°
// -----------------------------

// æ·±ã•å„ªå…ˆæ¢ç´¢ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ä½¿ã£ã¦è¿·è·¯ã‚’ç”Ÿæˆã™ã‚‹
const generateMaze = (width: number, height: number): Maze => {
  // ã™ã¹ã¦å£ï¼ˆ0ï¼‰ã§åˆæœŸåŒ–ã•ã‚ŒãŸè¿·è·¯ã‚’ä½œæˆ
  const maze: Maze = Array.from({ length: height }, () =>
    Array.from({ length: width }, () => 0)
  );

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é–‹å§‹åœ°ç‚¹ã‚’ã‚¹ã‚¿ãƒƒã‚¯ã«å…¥ã‚Œã‚‹ï¼ˆæ¢ç´¢ã®èµ·ç‚¹ï¼‰
  const stack: [number, number][] = [[START_X, START_Y]];

  // é–‹å§‹åœ°ç‚¹ã¯é€šè·¯ï¼ˆ1ï¼‰ã«è¨­å®š
  maze[START_Y][START_X] = 1;

  // æ¢ç´¢ã«ä½¿ã†ç§»å‹•æ–¹å‘ï¼ˆä¸Šä¸‹å·¦å³ã«2ãƒã‚¹ãšã¤ç§»å‹•ï¼‰
  const directions = [
    [2, 0],   // å³ã¸2ãƒã‚¹
    [-2, 0],  // å·¦ã¸2ãƒã‚¹
    [0, 2],   // ä¸‹ã¸2ãƒã‚¹
    [0, -2],  // ä¸Šã¸2ãƒã‚¹
  ];

  // é…åˆ—ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã™ã‚‹é–¢æ•°
  const shuffle = (arr: any[]) =>
    arr.sort(() => Math.random() - 0.5);

  // ã‚¹ã‚¿ãƒƒã‚¯ãŒç©ºã«ãªã‚‹ã¾ã§æ¢ç´¢ã‚’ç¹°ã‚Šè¿”ã™
  while (stack.length) {
    const [x, y] = stack.pop()!; // ç¾åœ¨ã®ä½ç½®ã‚’å–ã‚Šå‡ºã™

    // ãƒ©ãƒ³ãƒ€ãƒ ãªé †ã§éš£æ¥ãƒã‚¹ã‚’æ¢ç´¢
    shuffle(directions).forEach(([dx, dy]) => {
      const nx = x + dx; // æ¬¡ã®Xåº§æ¨™
      const ny = y + dy; // æ¬¡ã®Yåº§æ¨™

      // æ¬¡ã®ãƒã‚¹ãŒã¾ã æœªæ¢ç´¢ï¼ˆå£ï¼‰ã§ã‚ã‚Œã°
      if (maze[ny]?.[nx] === 0) {
        maze[ny][nx] = 1; // æ–°ã—ã„å ´æ‰€ã‚’é€šè·¯ã«ã™ã‚‹
        maze[y + dy / 2][x + dx / 2] = 1; // é–“ã®å£ã‚’å£Šã—ã¦é“ã‚’ã¤ãªã
        stack.push([nx, ny]); // æ–°ã—ã„åœ°ç‚¹ã‚’ã‚¹ã‚¿ãƒƒã‚¯ã«è¿½åŠ ã—ã¦å†å¸°çš„ã«é€²ã‚ã‚‹
      }
    });
  }

  // ã‚´ãƒ¼ãƒ«åœ°ç‚¹ã‚‚é€šè·¯ã«ã—ã¦ãŠãï¼ˆãŸã¾ã«å¡ãŒã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§æ˜ç¤ºçš„ã«ï¼‰
  maze[GOAL_Y][GOAL_X] = 1;

  // å®Œæˆã—ãŸè¿·è·¯ã‚’è¿”ã™
  return maze;
};

// -----------------------------
// Reactã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å®šç¾©
// -----------------------------

const App: React.FC = () => {
  // è¿·è·¯ã®çŠ¶æ…‹ï¼ˆ2æ¬¡å…ƒé…åˆ—ï¼‰ã‚’ç®¡ç†
  const [maze, setMaze] = useState<Maze>([]);

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ç¾åœ¨ä½ç½®ã‚’ç®¡ç†ï¼ˆXåº§æ¨™ã¨Yåº§æ¨™ï¼‰
  const [playerX, setPlayerX] = useState(START_X);
  const [playerY, setPlayerY] = useState(START_Y);

  // ã‚¿ã‚¤ãƒãƒ¼ã®ç§’æ•°ï¼ˆçµŒéæ™‚é–“ï¼‰ã‚’ç®¡ç†ã™ã‚‹çŠ¶æ…‹
  const [time, setTime] = useState(0);

  // ã‚´ãƒ¼ãƒ«ã«åˆ°é”ã—ãŸã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹çŠ¶æ…‹
  const [isGoalReached, setIsGoalReached] = useState(false);

  // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸã¨ãã«è¿·è·¯ã‚’ç”Ÿæˆã—ã€çŠ¶æ…‹ã‚’åˆæœŸåŒ–ã™ã‚‹
  useEffect(() => {
    setMaze(generateMaze(MAZE_WIDTH, MAZE_HEIGHT)); // è¿·è·¯ã‚’ç”Ÿæˆ
    setPlayerX(START_X); // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä½ç½®ã‚’åˆæœŸåŒ–
    setPlayerY(START_Y);
    setTime(0); // ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
    setIsGoalReached(false); // ã‚´ãƒ¼ãƒ«çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
  }, []);

  // â± ã‚¿ã‚¤ãƒãƒ¼ã®ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—å‡¦ç†
  useEffect(() => {
    // ã‚´ãƒ¼ãƒ«ã«åˆ°é”ã—ã¦ã„ãŸã‚‰ã‚¿ã‚¤ãƒãƒ¼ã‚’æ­¢ã‚ã‚‹
    if (isGoalReached) return;

    // 1ç§’ã”ã¨ã«ã‚¿ã‚¤ãƒãƒ¼ã‚’1ç§’åŠ ç®—ã™ã‚‹
    const timer = setInterval(() => {
      setTime((prev) => prev + 1);
    }, 1000);

    // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸã¨ãã«ã‚¿ã‚¤ãƒãƒ¼ã‚’æ­¢ã‚ã‚‹
    return () => clearInterval(timer);
  }, [isGoalReached]);

  // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œã‚’æ¤œçŸ¥ã—ã¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‹•ã‹ã™å‡¦ç†
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      e.preventDefault(); // â† ãƒ–ãƒ©ã‚¦ã‚¶ãŒçŸ¢å°ã‚­ãƒ¼ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãªã„ã‚ˆã†ã«é˜²æ­¢

      // æ¬¡ã«ç§»å‹•ã™ã‚‹äºˆå®šã®åº§æ¨™ï¼ˆåˆæœŸå€¤ã¯ç¾åœ¨ä½ç½®ï¼‰
      let nx = playerX;
      let ny = playerY;

      // æŠ¼ã•ã‚ŒãŸã‚­ãƒ¼ã«å¿œã˜ã¦ç§»å‹•æ–¹å‘ã‚’æ±ºå®š
      if (e.key === 'ArrowUp') ny -= 1;
      if (e.key === 'ArrowDown') ny += 1;
      if (e.key === 'ArrowLeft') nx -= 1;
      if (e.key === 'ArrowRight') nx += 1;

      // ç§»å‹•å…ˆãŒé€šè·¯ï¼ˆ1ï¼‰ã§ã‚ã‚Œã°ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä½ç½®ã‚’æ›´æ–°
      if (maze[ny]?.[nx] === 1) {
        setPlayerX(nx);
        setPlayerY(ny);

        // ã‚´ãƒ¼ãƒ«åœ°ç‚¹ã«åˆ°é”ã—ã¦ã„ãŸã‚‰ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
        if (nx === GOAL_X && ny === GOAL_Y) {
          setIsGoalReached(true);
        }
      }
    };

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²
    window.addEventListener('keydown', handleKeyDown);

    // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹ã¨ãã«ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [playerX, playerY, maze]);

  // -----------------------------
  // æç”»å‡¦ç†
  // -----------------------------
  return (
    <div>
      {/* ã‚¿ã‚¤ãƒãƒ¼ã®è¡¨ç¤ºï¼ˆã‚¯ãƒªã‚¢ã—ãŸã‚‰ ğŸ‰ ã‚’è¿½åŠ è¡¨ç¤ºï¼‰ */}
      <h2>
        Time: {time}s {isGoalReached && 'ğŸ‰ Clear!'}
      </h2>

      {/* è¿·è·¯ãƒãƒƒãƒ—ã®æç”» */}
      <div className="maze">
        {maze.map((row, y) =>
          row.map((cell, x) => {
            // ç¾åœ¨ã®ãƒã‚¹ãŒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½ç½®ã‹ã©ã†ã‹
            const isPlayer = x === playerX && y === playerY;

            // ç¾åœ¨ã®ãƒã‚¹ãŒã‚´ãƒ¼ãƒ«ã‹ã©ã†ã‹
            const isGoal = x === GOAL_X && y === GOAL_Y;

            // å„ãƒã‚¹ã‚’ <div> è¦ç´ ã¨ã—ã¦æç”»ã—ã€ã‚¯ãƒ©ã‚¹åã§ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¤‰æ›´
            return (
              <div
                key={`${x}-${y}`} // å„ãƒã‚¹ã®ã‚­ãƒ¼ã‚’åº§æ¨™ã§ä¸€æ„ã«è¨­å®š
                className={
                  isPlayer
                    ? 'cell player' // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãªã‚‰é’è‰²
                    : isGoal
                      ? 'cell goal' // ã‚´ãƒ¼ãƒ«ãªã‚‰èµ¤è‰²
                      : cell === 1
                        ? 'cell path' // é€šè·¯ãªã‚‰ç™½
                        : 'cell wall' // å£ãªã‚‰é»’
                }
              />
            );
          })
        )}
      </div>
    </div>
  );
};

export default App;
